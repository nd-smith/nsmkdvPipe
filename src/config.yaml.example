# Verisk Pipeline Configuration - Example Template
# Copy this file to config.yaml and replace placeholders with your actual values
# Multi-domain format - each domain under its own key

# IMPORTANT: Never commit config.yaml with real credentials to version control!
# Use environment variables for sensitive values (see docs/configuration.md)

xact:
  # Xact domain configuration
  kusto:
    # EVENTHOUSE_CLUSTER_URI env var overrides
    # Replace <YOUR_CLUSTER> with your actual Kusto cluster name
    cluster_uri: "https://<YOUR_CLUSTER>.z8.kusto.fabric.microsoft.com"
    # KQL_DATABASE env var overrides
    database: "VERISK_XACTANALYSIS_DB"
    table_name: "tbl_VERISK_XACTANALYSIS_STATUS_EXPORT"

  lakehouse:
    # LAKEHOUSE_ABFSS_PATH env var overrides
    # Replace <WORKSPACE_ID> and <LAKEHOUSE_ID> with your Azure Fabric workspace and lakehouse GUIDs
    abfss_path: "abfss://<WORKSPACE_ID>@onelake.dfs.fabric.microsoft.com/<LAKEHOUSE_ID>/Tables/dbo"
    events_table: "xact_events"
    attachments_table: "xact_attachments"  # Success-only inventory
    retry_table: "xact_retry"  # Active retry queue
    # FILES_BASE_PATH env var overrides (defaults to {abfss_path}/Files)
    files_path: "abfss://<WORKSPACE_ID>@onelake.dfs.fabric.microsoft.com/<LAKEHOUSE_ID>/Files/veriskPipeline/xact"

  processing:
    event_types:
      - "verisk.claims.property.xn.assignmentNoteAdded"
      - "verisk.claims.property.xn.status.*"
      - "verisk.claims.property.xn.documentsReceived"
      - "verisk.claims.property.xn.estimatePackageReceived"
      - "verisk.claims.property.xn.firstNoticeOfLossReceived"
    status_subtypes:
      - "documentsReceived"
      - "firstNoticeOfLossReceived"
      - "estimatePackageReceived"
    start_date: "2025-11-28T00:00:00"
    batch_size: 10
    max_events_to_scan: 10
    lookback_days: 3

  download:
    max_concurrent: 20
    timeout_seconds: 60
    max_retries: 3

  schedule:
    interval_seconds: 45
    enabled_stages:
      - "ingest"
      - "download"
      - "retry"

  retry:
    enabled: true
    batch_size: 100
    min_retry_age_seconds: 300
    max_retries: 4
    backoff_base_seconds: 300
    backoff_multiplier: 2.0
    max_concurrent: 5
    retention_days: 7  # Delete retry records older than this
    cleanup_on_start: true  # Run cleanup when retry stage starts

  security:
    allowed_attachment_domains:
      - "usw2-prod-xn-exportreceiver-publish.s3.us-west-2.amazonaws.com"
    audit_logging_enabled: true
    audit_log_path: "logs/xact_audit.log"

claimx:
  # ClaimX domain configuration
  kusto:
    # CLAIMX_KUSTO_URI env var overrides
    # Replace <YOUR_CLUSTER> with your actual Kusto cluster name
    cluster_uri: "https://<YOUR_CLUSTER>.z8.kusto.fabric.microsoft.com"
    # CLAIMX_DATABASE env var overrides
    database: "VERISK_CLAIMXPERIENCE_DB"
    events_table: "tbl_CLAIMXPERIENCE_EVENTS"

  api:
    # CLAIMX_API_URL env var overrides
    base_url: "https://www.claimxperience.com/service/cxedirest"
    # Name of env var containing Basic auth token
    auth_token_env: "CLAIMX_API_TOKEN"
    # CRITICAL: DO NOT hardcode auth tokens here!
    # Set CLAIMX_API_TOKEN environment variable with your base64-encoded credentials
    # Example: export CLAIMX_API_TOKEN="<your_base64_token>"
    _auth_token: ""
    timeout_seconds: 120
    max_concurrent: 100

  lakehouse:
    # CLAIMX_LAKEHOUSE_PATH env var overrides
    # Replace <WORKSPACE_ID> and <LAKEHOUSE_ID> with your Azure Fabric workspace and lakehouse GUIDs
    abfss_path: "abfss://<WORKSPACE_ID>@onelake.dfs.fabric.microsoft.com/<LAKEHOUSE_ID>/Tables/dbo"
    # CLAIMX_FILES_PATH env var overrides (defaults to {abfss_path}/Files)
    files_path: "abfss://<WORKSPACE_ID>@onelake.dfs.fabric.microsoft.com/<LAKEHOUSE_ID>/Files/veriskPipeline"
    # Table names (defaults shown)
    events_table: "claimx_events"
    projects_table: "claimx_projects"
    contacts_table: "claimx_contacts"
    media_metadata_table: "claimx_attachment_metadata"  # API metadata source
    tasks_table: "claimx_tasks"
    task_templates_table: "claimx_task_templates"
    external_links_table: "claimx_external_links"
    video_collab_table: "claimx_video_collab"
    event_log_table: "claimx_event_log"
    attachments_table: "claimx_attachments"  # Success-only inventory
    retry_table: "claimx_retry"  # Active retry queue

  processing:
    event_types:
      - "PROJECT_CREATED"
      - "PROJECT_FILE_ADDED"
      - "PROJECT_MFN_ADDED"
      - "CUSTOM_TASK_ASSIGNED"
      - "CUSTOM_TASK_COMPLETED"
      - "POLICYHOLDER_INVITED"
      - "POLICYHOLDER_JOINED"
      - "VIDEO_COLLABORATION_INVITE_SENT"
      - "VIDEO_COLLABORATION_COMPLETED"
      - "PROJECT_CONVERSATION_UPDATED"
      - "PERSONAL_PROPERTY_TASK_SHARED"
      - "PROJECT_AUTO_XA_LINKING_UNSUCCESSFUL"

    batch_size: 500
    max_events_to_scan: 500
    lookback_days: 7
    start_date: "2025-12-01T00:00:00"
    skip_dedup_check: true

  download:
    max_concurrent: 10
    timeout_seconds: 338
    # If using a corporate proxy, replace with your proxy URL
    # Otherwise, remove this line or set to empty string
    proxy: "http://proxy.internal.company.com:8080"

  retry:
    enabled: true
    batch_size: 100
    min_retry_age_seconds: 5
    max_retries: 3
    backoff_base_seconds: 1
    backoff_multiplier: 2.0
    max_concurrent: 10
    retention_days: 7  # Delete retry records older than this
    cleanup_on_start: true  # Run cleanup when retry stage starts

  schedule:
    interval_seconds: 5
    enabled_stages:
      - "ingest"
      - "enrich"
      - "download"
      - "retry"

  security:
    allowed_download_domains:
      - "claimxperience.s3.amazonaws.com"
      - "claimxperience.s3.us-east-1.amazonaws.com"
      - "www.claimxperience.com"
      - "xactware-claimx-us-prod.s3.us-west-1.amazonaws.com"
    audit_logging_enabled: true
    audit_log_path: "logs/claimx_audit.log"

# Shared settings (apply to all domains)
health:
  enabled: false
  host: "0.0.0.0"
  port: 8080

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  log_dir: "logs"

observability:
  json_logs: true
  log_upload_enabled: false
  log_upload_interval_cycles: 10
  log_retention_days: 7
  memory_checkpoints_enabled: true
  memory_checkpoint_level: DEBUG

security:
  audit_logging_enabled: true
  audit_log_path: "logs/audit.log"

# Required Environment Variables:
# ================================
# Authentication (choose one method):
#   - Azure CLI: Set AZURE_AUTH_INTERACTIVE=true
#   - Service Principal: Set AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID
#   - Token File: Set AZURE_TOKEN_FILE=/path/to/tokens.json
#
# ClaimX API:
#   - CLAIMX_API_TOKEN: Base64-encoded credentials for ClaimX API
#
# Optional Overrides:
#   - EVENTHOUSE_CLUSTER_URI: Override xact.kusto.cluster_uri
#   - CLAIMX_KUSTO_URI: Override claimx.kusto.cluster_uri
#   - LAKEHOUSE_ABFSS_PATH: Override xact.lakehouse.abfss_path
#   - CLAIMX_LAKEHOUSE_PATH: Override claimx.lakehouse.abfss_path
#
# See docs/configuration.md for complete environment variable documentation
